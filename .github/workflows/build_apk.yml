name: Build APK (Auto Fix - Stable)

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        mode: [docker, local, fallback]

    steps:
      - name: Checkout cÃ³digo
        uses: actions/checkout@v4

      - name: Instalar dependÃªncias bÃ¡sicas
        run: |
          sudo apt update
          sudo apt install -y python3 python3-pip python3-setuptools python3-venv git zip unzip openjdk-17-jdk

      - name: Instalar Buildozer e dependÃªncias
        run: |
          pip install --upgrade pip wheel
          pip install buildozer cython virtualenv

      - name: Instalar SDK e NDK manualmente
        run: |
          mkdir -p $HOME/android-sdk
          cd $HOME/android-sdk
          wget -q https://dl.google.com/android/repository/commandlinetools-linux-10406996_latest.zip -O cmdline-tools.zip
          unzip cmdline-tools.zip -d cmdline-tools
          mv cmdline-tools/cmdline-tools cmdline-tools/latest
          export ANDROID_HOME=$HOME/android-sdk
          export PATH=$ANDROID_HOME/cmdline-tools/latest/bin:$ANDROID_HOME/platform-tools:$PATH
          yes | sdkmanager --sdk_root=$ANDROID_HOME --licenses
          yes | sdkmanager --sdk_root=$ANDROID_HOME "platform-tools" "platforms;android-31" "build-tools;31.0.0" "ndk;21.4.7075529"

      - name: Descompactar projeto ZIP
        run: |
          if [ -f "analista_esportivo_app_package.zip" ]; then
            echo "ðŸ“¦ Descompactando projeto..."
            unzip -o analista_esportivo_app_package.zip -d ./app_project
          fi

      - name: Compilar APK com Buildozer
        run: |
          cd app_project
          export ANDROIDSDK=$HOME/android-sdk
          export ANDROIDNDK=$ANDROIDSDK/ndk/21.4.7075529
          export PATH=$ANDROIDSDK/platform-tools:$ANDROIDSDK/cmdline-tools/latest/bin:$PATH
          echo "ðŸš€ Iniciando build com modo: ${{ matrix.mode }}"
          buildozer android debug

      - name: Upload do APK
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: Analista-Esportivo-APK
          path: app_project/bin/*.apk
