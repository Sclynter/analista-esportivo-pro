name: Construir APK Analista Esportivo

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    timeout-minutes: 360
    env:
      ANDROID_SDK_ROOT: /home/runner/android-sdk
      ANDROID_HOME: /home/runner/android-sdk

    steps:
      - name: Checkout código
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Instalar dependências base e Java
        run: |
          sudo apt-get update -y
          sudo apt-get install -y wget unzip zip openjdk-17-jdk build-essential zlib1g-dev libncurses5 libffi-dev
          java -version

      - name: Configurar Python e Buildozer
        run: |
          python3 -m pip install --upgrade pip
          pip install buildozer cython virtualenv

      - name: Baixar e configurar Android SDK
        run: |
          mkdir -p "$ANDROID_SDK_ROOT/cmdline-tools"
          cd "$ANDROID_SDK_ROOT/cmdline-tools"
          wget https://dl.google.com/android/repository/commandlinetools-linux-9477386_latest.zip -O tools.zip
          unzip -q tools.zip
          mv cmdline-tools latest
          rm tools.zip
          echo "ANDROID_HOME=$ANDROID_SDK_ROOT" >> $GITHUB_ENV
          echo "PATH=$ANDROID_SDK_ROOT/cmdline-tools/latest/bin:$ANDROID_SDK_ROOT/platform-tools:$PATH" >> $GITHUB_ENV

      - name: Aceitar licenças e instalar SDKs necessários
        run: |
          yes | "$ANDROID_SDK_ROOT/cmdline-tools/latest/bin/sdkmanager" --licenses || true
          "$ANDROID_SDK_ROOT/cmdline-tools/latest/bin/sdkmanager" \
            "platform-tools" "platforms;android-33" "build-tools;33.0.2" "ndk;25.2.9519653"

      - name: Preparar projeto
        run: |
          if [ -f "./analista_esportivo_app_package.zip" ]; then
            unzip -q analista_esportivo_app_package.zip -d .
          fi
          if [ -f "./analista_esportivo_app/buildozer.spec" ]; then
            cd analista_esportivo_app
          elif [ -f "./buildozer.spec" ]; then
            cd .
          else
            echo "Arquivo buildozer.spec não encontrado!"
            exit 1
          fi
          echo "Diretório atual:"
          pwd
          ls -la

      - name: Construir APK com Buildozer
        run: |
          buildozer -v android debug

      - name: Upload do APK
        uses: actions/upload-artifact@v4
        with:
          name: AnalistaEsportivoPro-APK
          path: '**/bin/*.apk'
