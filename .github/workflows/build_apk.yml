name: Build APK with Buildozer (Docker - Final)

on:
  push:
    branches:
      - main

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout c√≥digo
        uses: actions/checkout@v4
        # O c√≥digo est√° em $GITHUB_WORKSPACE (diret√≥rio padr√£o)

      - name: Instalar Docker e Depend√™ncias B√°sicas (para garantir)
        # Instalamos o Docker, embora geralmente j√° esteja l√°.
        run: |
          sudo apt-get update
          sudo apt-get install -y zip unzip git python3 python3-pip docker.io

      - name: Preparar projeto (Descompactar)
        run: |
          if [ -f "./analista_esportivo_app_package.zip" ]; then
            unzip -o analista_esportivo_app_package.zip
            echo "üì¶ Pacote do app descompactado com sucesso!"
          fi

      # üîë CR√çTICO: Roda o container, mapeando o diret√≥rio de trabalho atual ($GITHUB_WORKSPACE)
      # para o /home/kivy, que √© o diret√≥rio de trabalho padr√£o do usu√°rio kivy dentro do container.
      - name: Construir APK com Buildozer (Docker)
        run: |
          # O ${{ github.workspace }} √© o caminho absoluto do seu projeto no runner.
          # O usu√°rio kivy dentro do container far√° o build com permiss√µes corretas.
          docker run --rm \
            -v "${{ github.workspace }}:/home/kivy/app" \
            -w /home/kivy/app \
            kivy/buildozer:stable \
            buildozer android debug
            
      # ‚ö†Ô∏è Nota: O APK ser√° gerado em 'bin/' no diret√≥rio raiz do seu reposit√≥rio.

      - name: Upload do APK
        uses: actions/upload-artifact@v4
        with:
          name: Analista-Esportivo-APK
          path: bin/*.apk
